{% extends "network/layout.html" %}
{% load static %}
{% block body %}
<div>
  <div class="post" data-post-id="{{ post.id }}">
      <a href="{% url 'profile' post.author.username %}"><strong>{{ post.author.username }}</strong> says:</a>
      <p class="post-content">{{ post.content }}</p>
      <p class="timestamp">{{ post.formated_created_at }}</p>
      <p>Likes: <span class="likes-count">{{ post.likes.count }}</span></p>
      <button class="like-button" id="postLikeBtn">
          {% if post.liked_by_user %}
              Unlike
          {% else %}
              Like
          {% endif %}
      </button>
      {% if user == post.author %}
        <button id="editBtn">Edit</button>
      {% endif %}
  </div>
  <div class="comments">
    <div class="container w-100">
      <form class="flex-column justify-content-between w-100" id="newComment">
        <input name="post_id" hidden value="{{ post.id }}">
        <div class="mb-3">
          <textarea class="form-control" name="content" id="commentContent"></textarea>
        </div>
        <button class="btn btn-dark" type="submit">Publish</button>
      </form>
      <div data-loader="form" class="spinner" style="display:none;"></div>
    </div>
    <div class="comments-container">
      {% for comment in comments %}
      <div class="comment" data-id="{{ comment.id }}">
        <p><strong>{{ comment.author.username }}</strong> says:</p>
        <p class="comment-content">{{ comment.content }}</p>
        <p class="timestamp">{{ comment.formated_created_at }}</p>
        <span>
          <p>Likes: <span class="likes-count">{{ comment.likes.count }}</span></p>
          <button id="commentLikeBtn">
            {% if comment.liked_by_user %}
              Unlike
            {% else %}
              Like
            {% endif %}
          </button>
        </span>
        {% if user == comment.author %}
          <button id="deleteCommentBtn">Delete</button>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}
{% block script %}
    <script type="module">
    import { showLoader, hideLoader, showBtnLoader, hideBtnLoader } from "{% static 'network/utils.js' %}";

        document.addEventListener("DOMContentLoaded", function () {
          const commentContainer = document.querySelector(".comments-container");
          const newCommentForm = document.querySelector("#newComment");

          newCommentForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const newForm = new FormData(newCommentForm);
            showLoader();
            fetch("/post/new_comment", {
              method: "POST",
              body: newForm,
              headers: {
                "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').getAttribute("content"),
              },
            }).then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                hiddeLoader();
                const newComment = document.createElement("div");
                newComment.classList.add("comment");
                const comment = data.new_comment
                newComment.setAttribute("data-id", comment.id);
                newComment.innerHTML = `
                          <p><strong>${ comment.author }</strong> says:</p>
                          <p class="comment-content">${ comment.content }</p>
                          <p class="timestamp">${ comment.formated_created_at}</p>
                          <span>
                            <p>Likes: <span class="likes-count">${ comment.likes_count }</span></p>
                            <button id="commentLikeBtn">Like</button>
                          </span>
                          <button id="deleteCommentBtn">Delete</button>
              `;
                commentContainer.prepend(newComment);
                newCommentForm.reset();
              }
            })
          });

          // Delegación de eventos para like/delete en comentarios (funciona con elementos dinámicos)
          const commentContainerEl = document.querySelector('.comments-container');
          if (commentContainerEl) {
            commentContainerEl.addEventListener('click', (e) => {
              const deleteBtn = e.target.closest('#deleteCommentBtn');
              if (deleteBtn) {
                const commentEl = deleteBtn.closest('.comment');
                const commentId = commentEl.getAttribute('data-id');
                fetch('/post/comment/delete', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                  },
                  body: JSON.stringify({ id: commentId }),
                })
                .then(res => res.json())
                .then(data => {
                  if (data.status === 'success') {
                    commentEl.remove();
                  } else {
                    console.error('Error deleting comment:', data);
                  }
                })
                .catch(err => console.error(err));
                return;
              }

              const likeBtn = e.target.closest('#commentLikeBtn');
              if (likeBtn) {
                const commentEl = likeBtn.closest('.comment');
                const commentId = commentEl.getAttribute('data-id');
                const likeCount = commentEl.querySelector('.likes-count');
                showBtnLoader(likeBtn);

                fetch('/post/comment/like', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                  },
                  body: JSON.stringify({ comment_id: commentId, content_type: 'comment' }),
                })
                .then(res => res.json())
                .then(data => {
                  if (data.status === 'success') {
                    likeCount.textContent = data.likes_count;
                    likeBtn.textContent = (data.action === 'liked') ? 'Unlike' : 'Like';
                  } else {
                    console.error('Error toggling comment like:', data);
                  }
                  hiddeBtnLoader(likeBtn);
                })
                .catch(err => console.error(err));
                return;
              }
            });
          }

          // Manejador de like para el post en la vista de detalle
          const postLikeBtn = document.querySelector('#postLikeBtn');
          if (postLikeBtn) {
            postLikeBtn.addEventListener('click', (e) => {
              const postDiv = e.target.closest('.post');
              const postId = postDiv.getAttribute('data-post-id');
              const likesCountSpan = postDiv.querySelector('.likes-count');
              showLoader(postLikeBtn);

              fetch('/post/like', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                },
                body: JSON.stringify({ post_id: postId, content_type: 'post' }),
              })
              .then(res => res.json())
              .then(data => {
                if (data.status === 'success') {
                  likesCountSpan.textContent = data.likes_count;
                  postLikeBtn.textContent = (data.action === 'liked') ? 'Unlike' : 'Like';
                } else {
                  console.error('Error toggling post like:', data);
                }
                hiddeLoader(postLikeBtn);
              })
              .catch(err => console.error(err));
            });
          }
        });
    </script>
{% endblock %}