{% extends "network/layout.html" %}
{% load static %}

{% block body %}
    <h2>{{ profile_user.username }}</h2>
    <div class="d-flex align-items-center justify-content-center mb-3 gap-4" id="infoProfile">
        <p>Followers: <span id="followers-count">{{ profile_user.followers_count }}</span></p>
        <p>Following: <span id="following-count">{{ profile_user.following_count }}</span></p>
    </div>
    {% if user != profile_user %}
        <form id="followForm">
            {% csrf_token %}
            <input type="hidden" name="username" value="{{ profile_user.username }}">
        </form>
        <button id="follow-btn" type="button">
            {% if is_following %}
                Unfollow
            {% else %}
                Follow
            {% endif %}
        </button>
    {% endif %}
    <h3>Posted by {{ profile_user.username }}</h3>
    <div id="posts-container">
        <div id="newPost" style="display: none;"></div>
        {% for post in posts %}
            <div class="post" data-post-id="{{ post.id }}">
                <p><strong>{{ post.author.username }}</strong> says:</p>
                <p class="post-content">{{ post.content }}</p>
                <p class="timestamp">{{ post.formated_created_at }}</p>
                <p>Likes: <span class="likes-count">{{ post.likes.count }}</span></p>
                <button class="like-button" id="likeBtn">
                    {% if post.liked_by_user %}
                        Unlike
                    {% else %}
                        Like
                    {% endif %}
                </button>
                {% if user.is_authenticated and user == post.author %}
                    <button id="editBtn">Edit</button>
                    <button id="deleteBtn">Delete</button>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    <div class="modal-background" style="display: none;">
        <div class="modal">
            <div class="modal-content">
                <h4>You are going to delete this post</h4>
                <form id="deleteForm">
                    <input type="hidden" name="post_id" value="">
                    <button type="submit">Confirm</button>
                    <button type="button" id="closeBtn">Cancel</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script src="{% static '/network/utils.js' %}" type="module"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const followForm = document.querySelector("#followForm");
            const followBtn = document.querySelector("#follow-btn");
            const followersCountSpan = document.querySelector("#followers-count");

            if (followBtn) {
                followBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    const formData = new FormData(followForm);
                    showBtnLoader(followBtn);
                    fetch("/follow", {
                        method: "POST",
                        body: formData,
                        headers: {
                            "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').getAttribute("content"),
                        },
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "success") {
                            followBtn.textContent = (data.action === "followed") ? "Unfollow" : "Follow";
                            followersCountSpan.textContent = data.followers_count;
                        }
                        hiddeBtnLoader(followBtn);
                    });
                });
            }

            const deleteButtons = document.querySelectorAll("#deleteBtn");
            const closeBtn = document.querySelector("#closeBtn");
            const deleteForm = document.querySelector("#deleteForm");

            deleteButtons.forEach( btn => {
                btn.addEventListener("click", function() {
                    const postId = this.closest(".post").getAttribute("data-post-id");
                    openModal(postId);
                });
            })

            closeBtn.addEventListener("click", function() {
                closeModal();
            });

            deleteForm.addEventListener("submit", function(e) {
                e.preventDefault();
                deletePost();
            });

            function openModal(post_id) {
                document.querySelector(".modal-background").style.display = "block";
                document.querySelector("#deleteForm input[name='post_id']").value = post_id;
            }
            
            function closeModal() {
                document.querySelector(".modal-background").style.display = "none";
            }
            function deletePost() {
                const postId = document.querySelector("#deleteForm input[name='post_id']").value;
                console.log("haciendo fetch")
                fetch("/post/delete", {
                    method: "POST",
                    body: JSON.stringify({ post_id: postId }),
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').getAttribute("content"),
                    },
                })
                .then((response) => response.json())
                .then((data) => {
                    console.log("se recibio respuesta")
                    if (data.status === "success") {
                        const postElement = document.querySelector(`.post[data-post-id='${postId}']`);
                        postElement.remove();
                    }
                });
                closeModal();
            }

        });
    </script>
    <script type="module" src="{% static '/network/index.js' %}"></script>
{% endblock %}