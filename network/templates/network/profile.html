{% extends "network/layout.html" %}
{% load static %}

{% block body %}
    <h2>{{ profile_user.username }}</h2>
    <p>Followers: <span id="followers-count">{{ profile_user.followers_count }}</span></p>
    <p>Following: <span id="following-count">{{ profile_user.following_count }}</span></p>
    {% if user != profile_user %}
        <form id="followForm">
            {% csrf_token %}
            <input type="hidden" name="username" value="{{ profile_user.username }}">
        </form>
        <button id="follow-btn" type="submit">
            {% if is_following %}
                Unfollow
            {% else %}
                Follow
            {% endif %}
        </button>
    {% endif %}
    <h3>Posted by {{ profile_user.username }}</h3>
    <div id="posts-container">
        <div id="newPost" style="display: none;"></div>
        {% for post in posts %}
            <div class="post" data-post-id="{{ post.id }}">
                <p><strong>{{ post.author.username }}</strong> says:</p>
                <p class="post-content">{{ post.content }}</p>
                <p>Likes: <span class="likes-count">{{ post.likes.count }}</span></p>
                <button class="like-button">
                    {% if user in post.likes.all %}
                        Unlike
                    {% else %}
                        Like
                    {% endif %}
                </button>
                {% if user == post.author %}
                    <button id="editBtn">Edit</button>
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% endblock %}
{% block script %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const followForm = document.querySelector("#followForm");
            const followBtn = document.querySelector("#follow-btn");
            const followersCountSpan = document.querySelector("#followers-count");

            followBtn.addEventListener("click", function (e) {
                e.preventDefault();
                const formData = new FormData(followForm);
                fetch("/follow", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
                    },
                })
                .then((response) => response.json())
                .then((data) => {
                    if (data.status === "success") {
                        console.log(data.is_following);
                        followBtn.textContent = (data.action === "followed") ? "Unfollow" : "Follow";
                        followersCountSpan.textContent = data.followers_count;
                    } 
                });
            });
        });
    </script>
{% endblock %}